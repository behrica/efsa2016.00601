---
output:
  word_document: 
    fig_caption: yes
    toc: yes
  html_document:
    fig_caption: yes
    toc: yes
---
```{r echo=F, results="hide",warning=F,message=F,cache=F}
library(pacman)
library(efsagis)
library(efsa2016.00601)
library(dplyr)


usePng <- F

nextPlot <- function(name) {

    if (usePng & !names(dev.cur())=="null device") {
        dev.off()
    }
    if (usePng) {
        png(paste0("./output/mapProposals/",name,".png"),width = 1366,height=768)
    } else {
        ##readline(prompt=paste0(name,": Press [enter] to continue"))
        
    }
    invisible()

}
if (usePng) {
    system("rm output/mapProposals/*.png")

}
data(NUTS_01M_2013,package="efsagis")
data(countries_01M_2013,package="efsagis")

knitr::opts_chunk$set(comment=NA, fig.width=14, fig.height=14/2.4,dpi=221,echo=F,cache=T)
world.eu <- worldEu()
EU_NUTS.0 <- euNuts0()
sc <- SparkR::sparkR.init(master="local",sparkPackages = "com.databricks:spark-csv_2.10:1.3.0")
sqlContext <- SparkR::sparkRSQL.init(sc)
```

```{r echo=F, results="hide",warning=F,message=F}
prepare_citrus_layer()
																																																																																						```

# EU citrus production surface area 
## data

```{r echo=F,warning=F,error=F,message=F}
data <-  latestData() 
mostRecentData <- data %>%
    dplyr::select(country,year,NUTS.Code,NUTS3.name,ha,citrus_density) %>%
    dplyr::arrange(NUTS.Code) 

pander::pander(mostRecentData %>% as.data.frame ,caption="Citrus product surface area per NUTS3 region")
```

```{r echo=F,warning=F,error=F,message=F}
countryHa <- data %>%
    dplyr::group_by(country) %>%
    dplyr::summarise(sum(ha))

pander::pander(countryHa %>% as.data.frame,digits=0,caption="Citrus product surface area per country")
```

```{r echo=F,warning=F,error=F,message=F}
comments <- data %>%
    dplyr::mutate(comment=ifelse(is.na(comment),"",comment)) %>%
    dplyr::group_by(country,year,comment) %>%
    dplyr::select(country,comment) %>%
    dplyr::slice(1)
pander::pander(comments %>% as.data.frame,caption="Notes on data transformations")
```

## in ha 
```{r warning=F,message=F,fig.cap="EU map of NUTS3 citrus growing regions based on citrus production data extracted from national statistical database of Portugal, Spain, France, Italy, Malta, Croatia, Greece and Cyprus"}
nextPlot("surface_ha")
## surface
base_layer() +
    worldCountries_layer(world.eu) +
    citrusSurface_layer(column="ha",alpha=1) +
    nuts0_layer()+
    nuts3_layer() +
    
    tmap::tm_format_Europe("EU citrus production")

```

## as density ha / km^2

```{r warning=F,message=F,fig.cap="EU map of NUTS3 citrus growing regions based on citrus production data extracted from national statistical database of Portugal, Spain, France, Italy, Malta, Croatia, Greece and Cyprus"}
nextPlot("surface_density")
base_layer() +
    worldCountries_layer(world.eu) +
    
    citrusSurface_layer(column="citrus_density",alpha=1) +
    
    nuts3_layer() +
    nuts0_layer()+

    tmap::tm_format_Europe() 
```

# Citrus surface + Magarey 2015 stations

## with ascospores infection score
```{r warning=F,message=F,fig.cap="Magharey 2015 EU locations and the reported ascospore infection score and the percentage of suitable years for infection",fig.keep="last"}
nextPlot("surface_MagAsco")
base_layer() +
    worldCountries_layer(world.eu) +
    citrusSurface_layer(column="ha") +
    nuts0_layer()+
    nuts3_layer() +
    magarey_layer("asco_days_average","asco_suit_years",
                  title.size = "Ascospores \ninfection score",
                  title.col = "Ascospores \n(% suitable years)",
                  style = "pretty") +
    tmap::tm_format_Europe()

```

## with pycnidiospres infection scores

```{r warning=F,message=F,fig.cap="Magharey 2015 EU locations and the reported pycnidiospores infection score and the percentage of suitable years for infection",fig.keep="last"}
nextPlot("surface_MagPycnidio")
##OK
base_layer() +
    worldCountries_layer(world.eu) +
    citrusSurface_layer(alpha=1,column="ha") +
    nuts3_layer() +
    nuts0_layer()+
    magarey_layer("pyc_average","pyc_suit_years",title.size = "Pycnidiospores \ninfection score",title.col = "Pycnidiospores \n(% suitable years)",style="cat") +
    tmap::tm_format_Europe()
```

# Citrus surface + EFSA 2014
## surface as polygon 

```{r warning=F,message=F,fig.cap="Overlap of EU citrus production regions and EFSA 2014 predicted infections"}
nextPlot("surface_efsa2014")
## renove grid borders
## try schraffierung 
base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    infection_layer("extdata/spores2/Asco_3_15_Model_AVG.xlsx","Sep",
                    "Proportion of infection events (%)",
                    1) +
    
    citrusSurface_outline_layer() +
    tmap::tm_format_Europe()
```

## surface as dots

```{r warning=F,message=F,fig.cap="Overlap of EU citrus production regions and EFSA 2014 predicted infections"}

nextPlot("surfaceDots_efsa2014")
base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    infection_layer("extdata/spores2/Asco_3_15_Model_AVG.xlsx","Sep",
                    "Proportion of infection events (%)",
                    1) +
    
    citrusSurface_dots_layer() +
    tmap::tm_format_Europe()
```



## surface as hatched plot
```{r warning=F,message=F,fig.cap="Overlap of EU citrus production regions and EFSA 2014 predicted infections"}

nextPlot("surfaceHatched_efsa2014")
plot_infection("extdata/spores2/Asco_3_15_Model_AVG.xlsx","Sep")
plot_citrus_density(add=T)
plot(EU_NUTS.0,add=T)
```


# Citrus surface + Martinez 2015

## Citrus surface as polygon 

### with Koeppen climate zones BSh+BSk

```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Koeppen-Geiger climate zones"}
nextPlot("surface_MartinezKoppenBskBsh")

base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    combined_koppen_layer(whichToShow = c(5,6))+
    citrusSurface_outline_layer() +
    tmap::tm_format_Europe()
```

### with Koeppen climate zones BSh,BSk,CSa,CSb
```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Koeppen-Geiger climate zones"}
nextPlot("surface_MartinezKoppen")

base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    combined_koppen_layer()+
    citrusSurface_outline_layer() +
    tmap::tm_format_Europe()

```

### with Aschmann mediteranian climat zone

```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Aschmann mediteranian climate zone"}
nextPlot("surface_MartinezAschmann")
base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    aschmann_layer() +
    citrusSurface_outline_layer()  +
    tmap::tm_format_Europe()

```

## citrus surface as dot plots

### with Koeppen climate zones BSh,BSk,CSa,CSb

```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Koeppen-Geiger climate zones"}
nextPlot("surfaceDots_MartinezKoppen")
base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    combined_koppen_layer() +
    citrusSurface_dots_layer() +
    tmap::tm_format_Europe()

```

### with Aschmann mediteranian climat zone


```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Aschmann mediteranian climate zone"}

nextPlot("surfaceDots_MartinezAschmann")
base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    aschmann_layer() +
    citrusSurface_dots_layer() +
    tmap::tm_format_Europe()

```


## citrus surface as hatched polygons
### with Koeppen climate zones BSh,BSk
```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Koeppen-Geiger climate zones"}

nextPlot("surfaceHatched_MartinezKoppen")
plot_citrus_koppen_schraffiert()
```


# rain/non rain comparison

```{r warning=F,message=F,fic.cap="EFSA 2104 infections for Magarey 2015 locations"}
p_load(SparkR)
sum_by_rain_gridno <- sum_by_rain_gridno(sqlContext)
joined <- joinEfsaGridMagereyPts(sum_by_rain_gridno,"`sum(INFECTION_EVENTS)`")
pander::pander(joined %>% dplyr::select(Country,Location,ind_rain,`sum(INFECTION_EVENTS)`) %>%
               as.data.frame,
               caption = "EFSA 2104 infections for Magarey 2015 locations")
p_unload(SparkR)
```

```{r warning=F,message=F,fig.cap="EFSA 2104 infections for Magarey 2015 locations"}
plotMag2015byRain(joined)
```

```{r warning=F,message=F,fig.cap="Average EFSA 2014 infections on days without rain (July)"}
plotInfections(sum_by_rain_gridno,0,"sum(INFECTION_EVENTS)") 
```

```{r warning=F,message=F,fig.cap="Average EFSA 2014 infections on days with rain (July)"}
plotInfections(sum_by_rain_gridno,1,"sum(INFECTION_EVENTS)") 
```


```{r warning=F,message=F,results="hide"}

if(usePng) {
    dev.off()
    zip("mapProposals.zip","./output/mapProposals/")
}
```

