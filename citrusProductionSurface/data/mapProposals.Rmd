---
output:
  word_document: 
    fig_caption: yes
    toc: yes
  html_document:
    fig_caption: yes
    toc: yes
---

```{r echo=F, results="hide",warning=F,message=F,}
library(pacman)
.libPaths(c(file.path(Sys.getenv("SPARK_HOME"), "R", "lib"), .libPaths()))
p_load(SparkR)
p_load(dplyr)
source("./combine.R")
source("./compareRain_spark.R")
p_load(devEMF)
p_load(knitr)
p_unload(raster)
p_unload(SparkR)
usePng <- F

nextPlot <- function(name) {
    if (usePng & !names(dev.cur())=="null device") {
        dev.off()
    }
    if (usePng) {
        png(paste0("./output/mapProposals/",name,".png"),width = 1366,height=768)
    } else {
                                        #readline(prompt=paste0(name,": Press [enter] to continue"))
        
    }
    invisible()

}
if (usePng) {
    system("rm output/mapProposals/*.png")
}
opts_chunk$set(comment=NA, fig.width=14, fig.height=14/2.4,dpi=221,echo=F)
prepare_citrus_layer()

```

# EU citrus production surface area 

## in ha 
```{r warning=F,message=F,fig.cap="EU map of NUTS3 citrus growing regions based on citrus production data extracted from national statistical database of Portugal, Spain, France, Italy, Malta, Croatia, Greece and Cyprus"}
nextPlot("surface_ha")
## surface

base_layer() +
    worldCountries_layer(world.eu) +
    citrusSurface_layer(column="ha",alpha=1) +
    nuts0_layer()+
    nuts3_layer() +
  
    tm_format_Europe("EU citrus production")

```

## as density ha / km^2

```{r warning=F,message=F,fig.cap="EU map of NUTS3 citrus growing regions based on citrus production data extracted from national statistical database of Portugal, Spain, France, Italy, Malta, Croatia, Greece and Cyprus"}
nextPlot("surface_density")
base_layer() +
    worldCountries_layer(world.eu) +
    
    citrusSurface_layer(column="citrus_density",alpha=1) +
    
    nuts3_layer() +
    nuts0_layer()+

    tm_format_Europe() 
```

# Citrus surface + Magarey 2015 stations

## with ascospores infection score
```{r warning=F,message=F,fig.cap="Magharey 2015 EU locations and the reported ascospore infection score and the percentage of suitable years for infection",fig.keep="last"}
nextPlot("surface_MagAsco")
##OKb
base_layer() +
    worldCountries_layer(world.eu) +
    citrusSurface_layer(column="ha") +
    nuts0_layer()+
    nuts3_layer() +
    magarey_layer("asco_days_average","asco_suit_years",
                  title.size = "Ascospores \ninfection score",
                  title.col = "Ascospores \n(% suitable years)",
                  style = "pretty") +
    tm_format_Europe()

```

## with pycnidiospres infection scores

```{r warning=F,message=F,fig.cap="Magharey 2015 EU locations and the reported pycnidiospores infection score and the percentage of suitable years for infection",fig.keep="last"}
nextPlot("surface_MagPycnidio")
##OK
base_layer() +
    worldCountries_layer(world.eu) +
    citrusSurface_layer(alpha=1,column="ha") +
    nuts3_layer() +
    nuts0_layer()+
    magarey_layer("pyc_average","pyc_suit_years",title.size = "Pycnidiospores \ninfection score",title.col = "Pycnidiospores \n(% suitable years)",style="cat") +
    tm_format_Europe()
```

# Citrus surface + EFSA 2014
## surface as polygon 

```{r warning=F,message=F,fig.cap="Overlap of EU citrus production regions and EFSA 2014 predicted infections"}
nextPlot("surface_efsa2014")
## renove grid borders
## try schraffierung 
base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    infection_layer("./spores2/Asco_3_15_Model_AVG.xlsx","Sep",
                    "Proportion of infection events (%)",
                    1) +
                                        
    citrusSurface_outline_layer() +
    tm_format_Europe()
```

## surface as dots

```{r warning=F,message=F,fig.cap="Overlap of EU citrus production regions and EFSA 2014 predicted infections"}

nextPlot("surfaceDots_efsa2014")
base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    infection_layer("./spores2/Asco_3_15_Model_AVG.xlsx","Sep",
                    "Proportion of infection events (%)",
                    1) +
    
    citrusSurface_dots_layer() +
    tm_format_Europe()
```



## surface as hatched plot
```{r warning=F,message=F,fig.cap="Overlap of EU citrus production regions and EFSA 2014 predicted infections"}

nextPlot("surfaceHatched_efsa2014")
plot_infection("./spores2/Asco_3_15_Model_AVG.xlsx","Sep")
plot_citrus_density(add=T)
plot(EU_NUTS.0,add=T)
```


# Citrus surface + Martinez 2015

## Citrus surface as polygon 

### with Koeppen climate zones BSh+BSk

```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Koeppen-Geiger climate zones"}
nextPlot("surface_MartinezKoppenBskBsh")

base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    combined_koppen_layer(whichToShow = c(5,6))+
    citrusSurface_outline_layer() +
    tm_format_Europe()
```

### with Koeppen climate zones BSh,BSk,CSa,CSb
```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Koeppen-Geiger climate zones"}
nextPlot("surface_MartinezKoppen")

base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    combined_koppen_layer()+
    citrusSurface_outline_layer() +
    tm_format_Europe()

```

### with Aschmann mediteranian climat zone

```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Aschmann mediteranian climate zone"}
nextPlot("surface_MartinezAschmann")
base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    aschmann_layer() +
    citrusSurface_outline_layer()  +
    tm_format_Europe()

```

## citrus surface as dot plots

### with Koeppen climate zones BSh,BSk,CSa,CSb

```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Koeppen-Geiger climate zones"}
nextPlot("surfaceDots_MartinezKoppen")
base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    combined_koppen_layer() +
    citrusSurface_dots_layer() +
    tm_format_Europe()

```

### with Aschmann mediteranian climat zone


```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Aschmann mediteranian climate zone"}

nextPlot("surfaceDots_MartinezAschmann")
base_layer() +
    nuts0_layer()+
    worldCountries_layer(world.eu) +
    nuts3_layer() +
    aschmann_layer() +
    citrusSurface_dots_layer() +
    tm_format_Europe()
```


## citrus surface as hatched polygons
### with Koeppen climate zones BSh,BSk
```{r warning=F,message=F,fig.cap="Overlap of citrus production area and Koeppen-Geiger climate zones"}

nextPlot("surfaceHatched_MartinezKoppen")
plot_citrus_koppen_schraffiert()
```


# rain/non rain comparison

```{r}
source("./compareRain_spark.R")
joined <- joinEfsaGridMagereyPts(sum_by_rain_gridno,"`sum(INFECTION_EVENTS)`")
plotMag2015byRain(joined)
```

```{r fig.cap="Average EFSA 2014 infections on days without rain (July)"}
plotInfections(avg_by_gridno_rain_month %>% filter(month==7),0,"avg(INFECTION_EVENTS)") 
```

```{r}
plotInfections(avg_by_gridno_rain_month %>% filter(month==7),1,"avg(INFECTION_EVENTS)") 
```


```{r warning=F,message=F,results="hide"}
dev.off()

if(usePng) {
    zip("mapProposals.zip","./output/mapProposals/")
}


